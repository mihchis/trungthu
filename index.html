<!DOCTYPE html><html lang="vi"><head>
    <meta charset="UTF-8">
    <title>Trung thu vui v·∫ª nh√©</title>
    
    <!-- Meta tags cho SEO v√† chia s·∫ª m·∫°ng x√£ h·ªôi -->
    <meta name="description" content="B·∫°n th·∫≠t may m·∫Øn khi nh·∫≠n ƒë∆∞·ª£c m√≥n qu√† n√†y. Ch√∫c b·∫°n v√† gia ƒë√¨nh lu√¥n lu√¥n h·∫°nh ph√∫c üåï‚ú®">
    <meta name="keywords" content="trung thu, l·ªùi ch√∫c, m∆∞a ch·ªØ 3D, t√¨nh y√™u, h·∫°nh ph√∫c, trƒÉng r·∫±m, messenger, facebook">
    <meta name="author" content="Trung Thu">
    
    <!-- Open Graph Meta Tags cho Facebook & Messenger -->
    <meta property="og:title" content="üåï Trung thu vui v·∫ª nh√©">
    <meta property="og:description" content="B·∫°n th·∫≠t may m·∫Øn khi nh·∫≠n ƒë∆∞·ª£c m√≥n qu√† n√†y. Ch√∫c b·∫°n v√† gia ƒë√¨nh lu√¥n lu√¥n h·∫°nh ph√∫c üåï‚ú®">
    <meta property="og:image" content="images/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Trung thu vui v·∫ª nh√© - L·ªùi ch√∫c h·∫°nh ph√∫c v·ªõi m·∫∑t trƒÉng v√† th·ªè">
    <meta property="og:url" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Trung Thu 3D">
    <meta property="og:locale" content="vi_VN">
    
    <!-- Facebook App ID cho Messenger (n·∫øu c√≥) -->
    <meta property="fb:app_id" content="">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="üåï Trung thu vui v·∫ª nh√©">
    <meta name="twitter:description" content="B·∫°n th·∫≠t may m·∫Øn khi nh·∫≠n ƒë∆∞·ª£c m√≥n qu√† n√†y. Ch√∫c b·∫°n v√† gia ƒë√¨nh lu√¥n lu√¥n h·∫°nh ph√∫c üåï‚ú®">
    <meta name="twitter:image" content="https://trung-thu-two.vercel.app/image/og-image.png">
    <meta name="twitter:image:alt" content="Trung thu vui v·∫ª nh√© - L·ªùi ch√∫c h·∫°nh ph√∫c v·ªõi m·∫∑t trƒÉng v√† th·ªè">
    
    <!-- Additional Meta Tags cho Messenger -->
    <meta property="article:author" content="Trung Thu">
    <meta property="article:section" content="L·ªùi ch√∫c">
    <meta property="article:tag" content="trung thu, l·ªùi ch√∫c, t√¨nh y√™u">
    
    <!-- Additional Meta Tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ff69b4">
    <meta name="robots" content="index, follow">
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
    </style>
</head>

<body>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            <div class="loading-subtitle">Vui l√≤ng ch·ªù trong gi√¢y l√°t</div>
        </div>
    </div>

    <!-- Error Screen -->
    <div class="error-screen" id="errorScreen" style="display: none;">
        <div class="error-container">
            <div class="error-icon">‚ö†Ô∏è</div>
            <div class="error-title">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</div>
            <div class="error-message">Vui l√≤ng ki·ªÉm tra ID trong URL ho·∫∑c k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i</div>
            <button class="error-button" onclick="location.reload()">Th·ª≠ l·∫°i</button>
        </div>
    </div>

    <!-- Background stars -->
    <div class="stars" id="stars"></div>

    <!-- Audio element -->
    <audio id="backgroundMusic" loop="" preload="auto" crossorigin="anonymous">
        <source src="media/anhnangcuaanh.mp3" type="audio/mpeg">
        <source src="media/denbenanh.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Gift container -->
    <div class="gift-container" id="giftContainer">
        <img src="images/rabbits.gif" alt="Gift" class="gift">
    </div>

    <!-- Gift xu·∫•t hi·ªán ·ªü g√≥c tr√°i -->
    <div class="gift-appear" id="giftAppear">
        <img src="images/gift.png" alt="Gift" class="gift-image" id="giftImage">
    </div>

    <!-- Dialog popup -->
    <div class="dialog-overlay" id="dialogOverlay">
        <div class="dialog">
            <p>Ch√∫c b·∫°n m·ªôt m√πa Trung Thu tr√†n ƒë·∫ßy ni·ªÅm vui, h·∫°nh ph√∫c v√† may m·∫Øn! üåï‚ú®<br>
                Mong r·∫±ng nh·ªØng ƒëi·ªÅu t·ªët ƒë·∫πp nh·∫•t s·∫Ω ƒë·∫øn v·ªõi b·∫°n trong nƒÉm nay!
                <br>
                ƒê√¢y l√† m√≥n qu√† c·ªßa ng∆∞·ªùi ·∫•y d√†nh cho b·∫°n 
                üê∞üåô
            </p>

            <div class="dialog-image-container">
                <img src="images/dialog.png" alt="Dialog Background" class="dialog-background">
                <img src="images/gift.gif" alt="Gift" class="qr-overlay" id="giftImage" style="cursor: pointer;" onerror="this.style.display='none'; console.error('Kh√¥ng th·ªÉ load ·∫£nh Gift:', this.src);">
            </div>

            <button onclick="closeDialog()">ƒê√≥ng</button>
        </div>
    </div>
    <!-- Moon with rabbit - Top right -->
    <div class="moon-section">
        <img src="images/moon.png" alt="TrƒÉng R·∫±m" class="moon">
        <!-- Music control button -->
        <div class="music-control" id="musicControl">
            <button id="playPauseBtn" class="play-pause-btn">
                <span id="playIcon">üéµ</span>
            </button>
        </div>
        
    </div>

    <!-- Flying rabbit with ribbons - Middle left -->
    <div class="flying-rabbit-section">
        <img src="images/rabbits.png" alt="Th·ªè bay" class="flying-rabbit">
    </div>

    <!-- Traditional woman - Bottom right -->
    <div class="woman-section">
        <img src="images/sister.png" alt="Ng∆∞·ªùi ph·ª• n·ªØ truy·ªÅn th·ªëng" class="woman">
    </div>

    <!-- Mountain/Cloud shapes - Bottom -->
    <div class="mountain-section">
        <img src="images/mountain.png" alt="Mountain" class="mountain">
    </div>

    <div class="floating-lanterns">
        <img src="images/lantern.png" alt="ƒê√®n l·ªìng bay" class="lantern">
        <img src="images/lantern2.png" alt="ƒê√®n l·ªìng bay" class="lantern">
        <img src="images/lantern.png" alt="ƒê√®n l·ªìng bay" class="lantern">
        <img src="images/lantern2.png" alt="ƒê√®n l·ªìng bay" class="lantern">
        <img src="images/lantern.png" alt="ƒê√®n l·ªìng bay" class="lantern">
        <img src="images/lantern2.png" alt="ƒê√®n l·ªìng bay" class="lantern">
    </div>


    <!-- Three.js -->
    <script src="js/three.min.js"></script>
    <script src="js/OrbitControls.js"></script>
<!-- 
    <script src="./detect-devtools.js"></script>
  <script type='text/javascript'>
        // Bypass for developers
        const keyName = 'key';
        const keyValue = '9ac7ec230e0e4513578f309d6d3579ad';

        // Handle via config
        DisableDevtool({
            tkName: keyName,
            md5: keyValue,
            interval: '100',
        });
    </script> -->

    <script>
        // Global variables ƒë·ªÉ l∆∞u d·ªØ li·ªáu t·ª´ JSON
        let apiData = null;
        let currentId = null;
        let giftLink = null; // L∆∞u link qu√† t·∫∑ng t·ª´ JSON

        // Function ƒë·ªÉ l·∫•y ID t·ª´ URL parameters
        function getIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }



        // Function ƒë·ªÉ l·∫•y d·ªØ li·ªáu theo ID t·ª´ response.json
        async function fetchDataFromJSON(id) {
            try {
                const response = await fetch('response.json');
                const result = await response.json();
                
                if (result.success && result.data && Array.isArray(result.data)) {
                    let selectedData = null;
                    
                    if (id) {
                        // T√¨m object c√≥ _id tr√πng v·ªõi id t·ª´ URL
                        selectedData = result.data.find(item => item._id === id);
                        console.log('T√¨m ki·∫øm ID:', id);
                    }
                    
                    // N·∫øu kh√¥ng t√¨m th·∫•y ho·∫∑c kh√¥ng c√≥ ID, l·∫•y object ƒë·∫ßu ti√™n
                    if (!selectedData) {
                        selectedData = result.data[0];
                        console.log('S·ª≠ d·ª•ng d·ªØ li·ªáu m·∫∑c ƒë·ªãnh (ƒë·∫ßu ti√™n)');
                    }
                    
                    if (selectedData) {
                        apiData = selectedData;
                        console.log('D·ªØ li·ªáu ƒë∆∞·ª£c ch·ªçn:', apiData);
                        return apiData;
                    } else {
                        throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu n√†o trong m·∫£ng');
                    }
                } else {
                    throw new Error(result.message || 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ho·∫∑c sai c·∫•u tr√∫c');
                }
            } catch (error) {
                console.error('L·ªói khi ƒë·ªçc file JSON:', error);
                return null;
            }
        }

        // Function ƒë·ªÉ test audio URL
        async function testAudioUrl(url) {
            return new Promise((resolve) => {
                const testAudio = new Audio();
                testAudio.crossOrigin = 'anonymous';
                
                testAudio.addEventListener('canplaythrough', () => {
                    console.log('Audio URL h·ª£p l·ªá:', url);
                    resolve(true);
                });
                
                testAudio.addEventListener('error', () => {
                    console.log('Audio URL kh√¥ng h·ª£p l·ªá:', url);
                    resolve(false);
                });
                
                testAudio.src = url;
                testAudio.load();
            });
        }

        // Function ƒë·ªÉ c·∫≠p nh·∫≠t audio source t·ª´ JSON
        async function updateAudioSource() {
            if (apiData && apiData.song) {
                const audio = document.getElementById('backgroundMusic');
                let audioUrl = apiData.song;
                
                // Ki·ªÉm tra n·∫øu l√† URL ƒë·∫ßy ƒë·ªß hay ch·ªâ l√† t√™n file
                if (apiData.song.startsWith('http://') || apiData.song.startsWith('https://')) {
                    // Test URL tr∆∞·ªõc khi s·ª≠ d·ª•ng
                    const isValid = await testAudioUrl(apiData.song);
                    if (isValid) {
                        audio.src = apiData.song;
                        console.log('ƒê√£ c·∫≠p nh·∫≠t audio source t·ª´ URL:', apiData.song);
                    } else {
                        console.log('URL audio kh√¥ng h·ª£p l·ªá, s·ª≠ d·ª•ng audio m·∫∑c ƒë·ªãnh');
                        audio.src = 'media/anhnangcuaanh.mp3';
                    }
                } else {
                    // N·∫øu ch·ªâ l√† t√™n file, th√™m ƒë∆∞·ªùng d·∫´n media/
                    audio.src = `media/${apiData.song}`;
                    console.log('ƒê√£ c·∫≠p nh·∫≠t audio source t·ª´ file:', apiData.song);
                }
                
                // Load l·∫°i audio ƒë·ªÉ √°p d·ª•ng source m·ªõi
                audio.load();
            }
        }


        // Function ƒë·ªÉ c·∫≠p nh·∫≠t URL ngay l·∫≠p t·ª©c
        function updateURLImmediately() {
            const currentUrl = window.location.href;
            const ogUrl = document.querySelector('meta[property="og:url"]');
            if (ogUrl) {
                ogUrl.setAttribute('content', currentUrl);
                console.log('ƒê√£ c·∫≠p nh·∫≠t og:url th√†nh:', currentUrl);
            }
        }

        // Function ƒë·ªÉ c·∫≠p nh·∫≠t meta tags cho chia s·∫ª m·∫°ng x√£ h·ªôi
        function updateSocialMetaTags() {
            // C·∫≠p nh·∫≠t URL ngay l·∫≠p t·ª©c (kh√¥ng c·∫ßn ƒë·ª£i JSON)
            updateURLImmediately();
            
            if (apiData) {
                // C·∫≠p nh·∫≠t title v√† description d·ª±a tr√™n d·ªØ li·ªáu JSON
                let customTitle = "Trung thu vui v·∫ª nh√©";
                let customDescription = "B·∫°n th·∫≠t may m·∫Øn khi nh·∫≠n ƒë∆∞·ª£c m√≥n qu√† n√†y. Ch√∫c b·∫°n v√† gia ƒë√¨nh lu√¥n lu√¥n h·∫°nh ph√∫c üåï‚ú®";
                
                // N·∫øu c√≥ t√™n ng∆∞·ªùi g·ª≠i, th√™m v√†o title
                if (apiData.senderName) {
                    customTitle = `Trung thu vui v·∫ª nh√© - T·ª´ ${apiData.senderName}`;
                    customDescription = `${apiData.senderName} g·ª≠i l·ªùi ch√∫c: B·∫°n th·∫≠t may m·∫Øn khi nh·∫≠n ƒë∆∞·ª£c m√≥n qu√† n√†y. Ch√∫c b·∫°n v√† gia ƒë√¨nh lu√¥n lu√¥n h·∫°nh ph√∫c üåï‚ú®`;
                }
                
                // C·∫≠p nh·∫≠t title c·ªßa trang
                document.title = customTitle;
                
                // C·∫≠p nh·∫≠t meta description
                const metaDescription = document.querySelector('meta[name="description"]');
                if (metaDescription) {
                    metaDescription.setAttribute('content', customDescription);
                }
                
                // C·∫≠p nh·∫≠t Open Graph tags
                const ogTitle = document.querySelector('meta[property="og:title"]');
                if (ogTitle) {
                    ogTitle.setAttribute('content', customTitle);
                }
                
                const ogDescription = document.querySelector('meta[property="og:description"]');
                if (ogDescription) {
                    ogDescription.setAttribute('content', customDescription);
                }
                
                // C·∫≠p nh·∫≠t Twitter tags
                const twitterTitle = document.querySelector('meta[name="twitter:title"]');
                if (twitterTitle) {
                    twitterTitle.setAttribute('content', customTitle);
                }
                
                const twitterDescription = document.querySelector('meta[name="twitter:description"]');
                if (twitterDescription) {
                    twitterDescription.setAttribute('content', customDescription);
                }
                
                // S·ª≠ d·ª•ng ·∫£nh tƒ©nh og-image.png v·ªõi URL ƒë·∫ßy ƒë·ªß
                const ogImagePath = 'https://trung-thu-two.vercel.app/image/og-image.png';
                const ogImageMeta = document.querySelector('meta[property="og:image"]');
                if (ogImageMeta) {
                    ogImageMeta.setAttribute('content', ogImagePath);
                }
                
                const twitterImageMeta = document.querySelector('meta[name="twitter:image"]');
                if (twitterImageMeta) {
                    twitterImageMeta.setAttribute('content', ogImagePath);
                }
                
                console.log('ƒê√£ c·∫≠p nh·∫≠t meta tags cho chia s·∫ª m·∫°ng x√£ h·ªôi v·ªõi ·∫£nh og-image.png');
            }
        }

        // Function ƒë·ªÉ l∆∞u link qu√† t·∫∑ng t·ª´ JSON
        function updateGiftLink() {
            if (apiData && apiData.linkQR && apiData.linkQR.trim() !== "") {
                // Ki·ªÉm tra URL c√≥ h·ª£p l·ªá kh√¥ng
                if (apiData.linkQR.startsWith('http://') || apiData.linkQR.startsWith('https://')) {
                    giftLink = apiData.linkQR;
                    console.log('ƒê√£ l∆∞u link qu√† t·∫∑ng:', giftLink);
                    
                    // C·∫≠p nh·∫≠t cursor ƒë·ªÉ hi·ªÉn th·ªã c√≥ th·ªÉ click
                    const giftImage = document.getElementById('giftImage');
                    if (giftImage) {
                        giftImage.style.cursor = 'pointer';
                        giftImage.title = 'Click ƒë·ªÉ m·ªü qu√† t·∫∑ng';
                    }
                    
                    // Hi·ªÉn th·ªã gift v√† th·ªè khi c√≥ link h·ª£p l·ªá
                    showGiftAndRabbit();
                } else {
                    giftLink = null;
                    console.log('URL qu√† t·∫∑ng kh√¥ng h·ª£p l·ªá:', apiData.linkQR);
                    hideGiftAndRabbit();
                }
            } else {
                giftLink = null;
                console.log('LinkQR tr·ªëng ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ JSON');
                hideGiftAndRabbit();
            }
        }

        // Function ƒë·ªÉ hi·ªÉn th·ªã gift v√† th·ªè
        function showGiftAndRabbit() {
            console.log('Hi·ªÉn th·ªã gift v√† th·ªè');
            
            // Hi·ªÉn th·ªã l·∫°i c√°c element
            const giftContainer = document.getElementById('giftContainer');
            const giftAppear = document.getElementById('giftAppear');
            
            if (giftContainer) {
                giftContainer.style.display = 'block';
            }
            if (giftAppear) {
                giftAppear.style.display = 'block';
            }
            
            // B·∫Øt ƒë·∫ßu animation
            startGiftAnimation();
        }

        // Function ƒë·ªÉ ·∫©n gift v√† th·ªè
        function hideGiftAndRabbit() {
            console.log('·∫®n gift v√† th·ªè v√¨ kh√¥ng c√≥ linkQR');
            
            // ·∫®n gift container (th·ªè ch·∫°y)
            const giftContainer = document.getElementById('giftContainer');
            if (giftContainer) {
                giftContainer.style.display = 'none';
            }
            
            // ·∫®n gift appear (gift ·ªü g√≥c tr√°i)
            const giftAppear = document.getElementById('giftAppear');
            if (giftAppear) {
                giftAppear.style.display = 'none';
            }
        }

        // Function ƒë·ªÉ hi·ªÉn th·ªã loading screen
        function showLoading() {
            const loadingScreen = document.getElementById('loadingScreen');
            const errorScreen = document.getElementById('errorScreen');
            loadingScreen.style.display = 'flex';
            errorScreen.style.display = 'none';
        }

        // Function ƒë·ªÉ ·∫©n loading screen
        function hideLoading() {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        }

        // Function ƒë·ªÉ hi·ªÉn th·ªã error screen
        function showError() {
            const loadingScreen = document.getElementById('loadingScreen');
            const errorScreen = document.getElementById('errorScreen');
            loadingScreen.style.display = 'none';
            errorScreen.style.display = 'flex';
        }

        // Function ƒë·ªÉ kh·ªüi t·∫°o d·ªØ li·ªáu
        async function initializeData() {
            showLoading();
            
            currentId = getIdFromUrl();
            console.log('ID t·ª´ URL:', currentId);
            
            const data = await fetchDataFromJSON(currentId);
            
            if (data) {
                // C·∫≠p nh·∫≠t c√°c th√†nh ph·∫ßn t·ª´ d·ªØ li·ªáu JSON
                await updateAudioSource();
                updateGiftLink();
                updateSocialMetaTags(); // C·∫≠p nh·∫≠t meta tags cho chia s·∫ª
                console.log('ƒê√£ t·∫£i th√†nh c√¥ng d·ªØ li·ªáu t·ª´ JSON');
                hideLoading();
            } else {
                console.warn('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ JSON');
                showError();
                return false;
            }
            return true;
        }

        // Function ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o l·ªói
        function showErrorMessage(message) {
            // T·∫°o th√¥ng b√°o t·∫°m th·ªùi
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(255, 0, 0, 0.8);
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                max-width: 300px;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // Create floating stars
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const numStars = 80;

            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 2 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }

        // Initialize stars when page loads
        window.addEventListener('load', createStars);

        // Dialog functions
        function showDialog() {
            const dialogOverlay = document.getElementById('dialogOverlay');
            dialogOverlay.classList.add('show');
        }

        function closeDialog() {
            const dialogOverlay = document.getElementById('dialogOverlay');
            dialogOverlay.classList.remove('show');
        }

        // Add click event to gift image
        document.addEventListener('DOMContentLoaded', function () {
            // C·∫≠p nh·∫≠t URL ngay khi DOM ready ƒë·ªÉ Messenger c√≥ th·ªÉ ƒë·ªçc
            updateURLImmediately();
            
            // Click v√†o gift ·ªü g√≥c tr√°i ƒë·ªÉ m·ªü dialog
            const giftAppearImage = document.getElementById('giftImage');
            if (giftAppearImage) {
                giftAppearImage.addEventListener('click', showDialog);
            }
            
            // Click v√†o gift trong dialog ƒë·ªÉ m·ªü link qu√† t·∫∑ng
            const dialogGiftImage = document.querySelector('.qr-overlay');
            if (dialogGiftImage) {
                dialogGiftImage.addEventListener('click', function() {
                    if (giftLink) {
                        window.open(giftLink, '_blank');
                        console.log('ƒê√£ m·ªü link qu√† t·∫∑ng:', giftLink);
                    } else {
                        console.log('Ch∆∞a c√≥ link qu√† t·∫∑ng t·ª´ backend');
                        // C√≥ th·ªÉ hi·ªÉn th·ªã th√¥ng b√°o cho user
                        alert('Ch∆∞a c√≥ link qu√† t·∫∑ng t·ª´ ng∆∞·ªùi g·ª≠i');
                    }
                });
            }
            
            // Music control functionality
            setupMusicControls();
        });

        // Music control functions
        function setupMusicControls() {
            const audio = document.getElementById('backgroundMusic');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const playIcon = document.getElementById('playIcon');
            let isPlaying = false;

            // Set volume to 50% for better user experience
            audio.volume = 0.5;

            // Play/Pause button click handler
            playPauseBtn.addEventListener('click', function() {
                if (isPlaying) {
                    audio.pause();
                    playIcon.textContent = 'üéµ';
                    playIcon.style.opacity = '0.7';
                } else {
                    audio.play().then(() => {
                        playIcon.textContent = '‚è∏Ô∏è';
                        playIcon.style.opacity = '1';
                    }).catch(error => {
                        console.log('Audio play failed:', error);
                        // Fallback: show play button even if audio fails
                        playIcon.textContent = 'üéµ';
                    });
                }
                isPlaying = !isPlaying;
            });

            // Auto-play on mobile after user interaction
            function enableAutoPlay() {
                // Try to play audio after user interaction
                audio.play().then(() => {
                    isPlaying = true;
                    playIcon.textContent = '‚è∏Ô∏è';
                    playIcon.style.opacity = '1';
                }).catch(error => {
                    console.log('Auto-play failed:', error);
                });
            }

            // Enable auto-play after first user interaction
            let hasInteracted = false;
            document.addEventListener('click', function() {
                if (!hasInteracted) {
                    hasInteracted = true;
                    enableAutoPlay();
                }
            }, { once: true });

            // Handle audio events
            audio.addEventListener('ended', function() {
                isPlaying = false;
                playIcon.textContent = 'üéµ';
                playIcon.style.opacity = '0.7';
            });

            audio.addEventListener('error', function() {
                console.log('Audio error occurred');
                playIcon.textContent = 'üîá';
                playIcon.style.opacity = '0.5';
            });
        }


        // Gift animation - ch·ªâ ch·∫°y khi c√≥ linkQR h·ª£p l·ªá
        function startGiftAnimation() {
            if (!giftLink) {
                console.log('Kh√¥ng c√≥ linkQR, b·ªè qua animation gift');
                return;
            }

            setTimeout(() => {
                const giftContainer = document.getElementById('giftContainer');
                const giftAppear = document.getElementById('giftAppear');

                if (giftContainer) {
                    giftContainer.classList.add('show');
                }

                // Sau 6 gi√¢y: ·∫®n th·ªè v√† hi·ªán gift ·ªü g√≥c tr√°i (s·ªõm h∆°n 2 gi√¢y)
                setTimeout(() => {
                    if (giftContainer) {
                        giftContainer.classList.remove('show');
                        giftContainer.style.opacity = '0';
                        giftContainer.style.animation = 'none'; // D·ª´ng animation di chuy·ªÉn
                    }

                    // Hi·ªán gift ·ªü g√≥c tr√°i v·ªõi hi·ªáu ·ª©ng
                    if (giftAppear) {
                        giftAppear.classList.add('show');
                    }
                }, 6700);
            }, 5000);
        }
        // scene + camera + renderer
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio || 1);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // orbit controls (xoay quanh controls.target)
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.07;

        // lights
        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambient);
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(10, 20, 10);
        scene.add(dir);

        // group ch·ª©a text (d·ªÖ set target)
        const textGroup = new THREE.Group();
        scene.add(textGroup);

        // Function ƒë·ªÉ l·∫•y danh s√°ch c√¢u ch√∫c t·ª´ JSON ho·∫∑c d·ªØ li·ªáu m·∫∑c ƒë·ªãnh
        function getTexts() {
            if (apiData && apiData.messages && apiData.messages.length > 0) {
                return apiData.messages;
            }
            // D·ªØ li·ªáu m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ t·ª´ JSON
            return [
            "iu em",
            "H·∫°nh ph√∫c",
            "Lu√¥n vui v·∫ª",
            "Mong t√¨nh y√™u ch√∫ng ta lu√¥n b·ªÅn l√¢u nh∆∞ trƒÉng r·∫±m ",
            "Trung thu 2025",
            "C·∫£m ∆°n em v√¨ t·∫•t c·∫£",
            "iu c√¥ng ch√∫a c·ªßa anh", 
            "i love you", 
            "m√£i nh∆∞ v·∫≠y nh√©"
        ];
        }

        let objects = []; // ch·ª©a mesh + speed
        let imageObjects = []; // ch·ª©a ·∫£nh bay l√™n

        // Function ƒë·ªÉ l·∫•y danh s√°ch ·∫£nh t·ª´ JSON ho·∫∑c d·ªØ li·ªáu m·∫∑c ƒë·ªãnh
        function getImagePaths() {
            if (apiData && apiData.images && apiData.images.length > 0) {
                return apiData.images;
            }
            // Tr·∫£ v·ªÅ m·∫£ng r·ªóng n·∫øu kh√¥ng c√≥ ·∫£nh t·ª´ JSON
            return [];
        }

        // h√†m t·∫°o mesh ·∫£nh 3D
        function makeImageMesh(imagePath) {
            const loader = new THREE.TextureLoader();
            const texture = loader.load(imagePath, function(texture) {
                // T√≠nh t·ªâ l·ªá g·ªëc c·ªßa ·∫£nh
                const aspectRatio = texture.image.width / texture.image.height;
                
                // ƒê·∫∑t k√≠ch th∆∞·ªõc d·ª±a tr√™n t·ªâ l·ªá g·ªëc
                const baseSize = 8;
                let width, height;
                
                if (aspectRatio > 1) {
                    // ·∫¢nh ngang
                    width = baseSize;
                    height = baseSize / aspectRatio;
                } else {
                    // ·∫¢nh d·ªçc ho·∫∑c vu√¥ng
                    width = baseSize * aspectRatio;
                    height = baseSize;
                }
                
                // C·∫≠p nh·∫≠t geometry v·ªõi t·ªâ l·ªá ƒë√∫ng
                const geometry = new THREE.PlaneGeometry(width, height);
                mesh.geometry.dispose();
                mesh.geometry = geometry;
            });
            
            const material = new THREE.MeshBasicMaterial({
                map: texture,
                transparent: true,
                side: THREE.DoubleSide
            });

            const geometry = new THREE.PlaneGeometry(8, 8); // k√≠ch th∆∞·ªõc t·∫°m th·ªùi
            const mesh = new THREE.Mesh(geometry, material);

            // th√™m thu·ªôc t√≠nh ƒë·ªÉ ƒëi·ªÅu khi·ªÉn qu·ªπ ƒë·∫°o bay
            mesh.userData = {
                originalY: mesh.position.y,
                originalX: mesh.position.x,
                originalZ: mesh.position.z,
                pattern: Math.floor(Math.random() * 3) // 0: th·∫≥ng, 1: ch√©o tr√°i, 2: ch√©o ph·∫£i
            };

            return mesh;
        }

        // ƒê·ª£i Google Fonts load xong tr∆∞·ªõc khi t·∫°o text
        document.fonts.ready.then(function() {
            console.log('Fonts loaded successfully');
        });

        // Function ƒë·ªÉ test Messenger preview
        function testMessengerPreview() {
            console.log('=== MESSENGER PREVIEW TEST ===');
            console.log('Title:', document.querySelector('meta[property="og:title"]')?.getAttribute('content'));
            console.log('Description:', document.querySelector('meta[property="og:description"]')?.getAttribute('content'));
            console.log('Image:', document.querySelector('meta[property="og:image"]')?.getAttribute('content'));
            console.log('URL:', document.querySelector('meta[property="og:url"]')?.getAttribute('content'));
            console.log('==============================');
        }

        // Kh·ªüi t·∫°o d·ªØ li·ªáu khi trang load
        window.addEventListener('load', async function() {
            // C·∫≠p nh·∫≠t URL ngay l·∫≠p t·ª©c ƒë·ªÉ Messenger c√≥ th·ªÉ ƒë·ªçc ƒë√∫ng
            updateSocialMetaTags();
            
            // Test Messenger preview
            testMessengerPreview();
            
            const success = await initializeData();
            // Ch·ªâ t·∫°o text v√† ·∫£nh khi c√≥ d·ªØ li·ªáu th√†nh c√¥ng
            if (success) {
                createTextAndImages();
            }
        });

        // Function ƒë·ªÉ t·∫°o text v√† ·∫£nh sau khi c√≥ d·ªØ li·ªáu
        function createTextAndImages() {
            // load font r·ªìi t·∫°o text 3D
            const fontLoader = new THREE.FontLoader();
            fontLoader.load('https://cdn.jsdelivr.net/npm/three@0.128.0/examples/fonts/helvetiker_regular.typeface.json', function (font) {
            // h√†m t·∫°o mesh text 3D
            function makeTextMesh(message) {
                const canvas = document.createElement("canvas");
                const context = canvas.getContext("2d");

                // T·ª± ƒë·ªông t√≠nh k√≠ch th∆∞·ªõc canvas d·ª±a tr√™n ƒë·ªô d√†i ch·ªØ
                context.font = "700 64px 'Dancing Script', cursive, 'Arial', sans-serif";
                const textMetrics = context.measureText(message);
                const textWidth = textMetrics.width;
                const textHeight = 80; // chi·ªÅu cao c·ªë ƒë·ªãnh

                // ƒê·∫∑t k√≠ch th∆∞·ªõc canvas v·ªõi padding
                canvas.width = Math.max(textWidth + 40, 200); // t·ªëi thi·ªÉu 200px
                canvas.height = textHeight + 20;

                context.font = "700 64px 'Dancing Script', cursive, 'Arial', sans-serif";
                context.fillStyle = "#ff69b4";
                context.textAlign = "center";
                context.textBaseline = "middle";
                context.fillText(message, canvas.width / 2, canvas.height / 2);

                const texture = new THREE.CanvasTexture(canvas);
                const material = new THREE.MeshBasicMaterial({
                    map: texture,
                    transparent: true,
                    side: THREE.DoubleSide  // ƒë·ªÉ nh√¨n ƒë∆∞·ª£c c·∫£ m·∫∑t tr∆∞·ªõc & sau
                });

                // T·ª± ƒë·ªông t√≠nh k√≠ch th∆∞·ªõc geometry d·ª±a tr√™n canvas
                const geometryWidth = (canvas.width / 512) * 12; // t·ª∑ l·ªá v·ªõi canvas g·ªëc
                const geometryHeight = (canvas.height / 256) * 6;
                const geometry = new THREE.PlaneGeometry(geometryWidth, geometryHeight);
                const mesh = new THREE.Mesh(geometry, material);
                return mesh;
            }


            // t·∫°o nhi·ªÅu text 3D (s·ªë l∆∞·ª£ng moderate ƒë·ªÉ kh√¥ng lag)
            const texts = getTexts(); // L·∫•y d·ªØ li·ªáu ƒë·ªông
            const COUNT = 24; // n·∫øu ch·∫≠m gi·∫£m xu·ªëng 12-16
            for (let i = 0; i < 60; i++) {
                let text = texts[Math.floor(Math.random() * texts.length)];
                let mesh = makeTextMesh(text);
                // T·∫°o ch·ªØ v·ªõi kho·∫£ng c√°ch ƒë·ªÅu t·ª´ d∆∞·ªõi l√™n
                mesh.position.set((Math.random() - 0.5) * 80, -40 + (i * 1.5), (Math.random() - 0.5) * 80);
                scene.add(mesh);
                objects.push(mesh);
            }

            // t·∫°o ·∫£nh bay l√™n (√≠t h∆°n v√† ph√¢n b·ªë ƒë·ªÅu)
            const imagePaths = getImagePaths(); // L·∫•y d·ªØ li·ªáu ƒë·ªông
            if (imagePaths.length > 0) {
                for (let i = 0; i < 12; i++) {
                    let imagePath = imagePaths[Math.floor(Math.random() * imagePaths.length)];
                    let imageMesh = makeImageMesh(imagePath);

                    // ƒê·∫∑t v·ªã tr√≠ v·ªõi kho·∫£ng c√°ch ƒë·ªÅu ƒë·ªÉ tr√°nh ng·∫Øt qu√£ng
                    imageMesh.position.set(
                        (Math.random() - 0.5) * 80,
                        -80 + (i * 6), // kho·∫£ng c√°ch l·ªõn h∆°n ƒë·ªÉ ph√¢n t√°n
                        (Math.random() - 0.5) * 80
                    );

                    scene.add(imageMesh);
                    imageObjects.push(imageMesh);
                }
            } else {
                console.log('Kh√¥ng c√≥ ·∫£nh t·ª´ JSON, b·ªè qua t·∫°o ·∫£nh bay l√™n');
            }


            // ƒë·∫∑t camera v√† controls target ƒë·ªÉ xoay quanh group (kho·∫£ng gi·ªØa)
            camera.position.set(0, 12, 60);
            controls.target.set(0, 10, 0);
            controls.update();
            });
        }


        function animate() {
            requestAnimationFrame(animate);

            // Animation cho text
            objects.forEach(obj => {
                obj.position.y += 0.08; // bay l√™n ch·∫≠m h∆°n ƒë·ªÉ m∆∞·ª£t h∆°n
                if (obj.position.y > 50) {
                    obj.position.y = -50; // reset xu·ªëng d∆∞·ªõi xa h∆°n ƒë·ªÉ tr√°nh ƒë·ª©t qu√£ng
                }
            });

            // Animation cho ·∫£nh v·ªõi c√°c qu·ªπ ƒë·∫°o bay kh√°c nhau
            imageObjects.forEach(imgObj => {
                const pattern = imgObj.userData.pattern;

                // Bay l√™n (t·∫•t c·∫£ ƒë·ªÅu bay l√™n)
                imgObj.position.y += 0.06;

                // Qu·ªπ ƒë·∫°o bay kh√°c nhau - ch·ªâ thay ƒë·ªïi h∆∞·ªõng bay
                if (pattern === 0) {
                    // Bay th·∫≥ng l√™n (kh√¥ng di chuy·ªÉn ngang)
                    imgObj.position.x += 0;
                } else if (pattern === 1) {
                    // Bay ch√©o sang tr√°i (di chuy·ªÉn sang tr√°i khi bay l√™n)
                    imgObj.position.x -= 0.03;
                } else if (pattern === 2) {
                    // Bay ch√©o sang ph·∫£i (di chuy·ªÉn sang ph·∫£i khi bay l√™n)
                    imgObj.position.x += 0.03;
                }

                // Reset khi bay qu√° cao - reset xa h∆°n ƒë·ªÉ li·ªÅn m·∫°ch
                if (imgObj.position.y > 70) {
                    imgObj.position.y = -90; // reset xa h∆°n ƒë·ªÉ tr√°nh kho·∫£ng tr·ªëng
                    imgObj.position.x = (Math.random() - 0.5) * 80;
                    imgObj.position.z = (Math.random() - 0.5) * 80;
                    // Random l·∫°i pattern
                    imgObj.userData.pattern = Math.floor(Math.random() * 3);
                }
            });

            controls.update();
            renderer.render(scene, camera);
        }


        animate();

        // handle resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>


</body></html>